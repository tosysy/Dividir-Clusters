<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema FAT - Generador y Explorador</title>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #000000 0%, #ffffff 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .panel {
        background: #f5f5f5; /* gris claro */
        backdrop-filter: blur(6px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.5s ease-out;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid #ddd;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    h2 {
        color: #2d3748;
        font-size: 1.8em;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 3px solid #38b2ac;
        padding-bottom: 15px;
    }

    h3 {
        color: #4a5568;
        font-size: 1.3em;
        margin: 25px 0 15px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        color: #4a5568;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.95em;
    }

    input[type="text"],
    input[type="number"],
    select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.3s ease;
        background: white;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
        outline: none;
        border-color: #38b2ac;
        box-shadow: 0 0 0 3px rgba(56, 178, 172, 0.2);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }

    input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #38b2ac;
    }

    button {
        background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(56, 178, 172, 0.4);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(56, 178, 172, 0.6);
    }

    button:active {
        transform: translateY(0);
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 0.85em;
        width: auto;
        margin: 0;
        background: #ef4444;
    }

    .btn-small:hover {
        background: #dc2626;
    }

    pre {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        padding: 20px;
        border-radius: 12px;
        font-size: 14px;
        white-space: pre-wrap;
        border: 2px solid #e2e8f0;
        font-family: 'Courier New', monospace;
        line-height: 1.6;
        color: #2d3748;
        max-height: 400px;
        overflow-y: auto;
    }

    .instr-item {
        background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
        margin: 10px 0;
        padding: 15px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #38b2ac;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .instr-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(56, 178, 172, 0.2);
    }

    .instr-text {
        font-family: 'Courier New', monospace;
        color: #2d3748;
        font-size: 0.9em;
        flex: 1;
    }

    .stats-badge {
        display: inline-block;
        background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1.1em;
        box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #a0aec0;
        font-style: italic;
    }

    .divider {
        height: 2px;
        background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
        margin: 25px 0;
    }

    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #38b2ac;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #319795;
    }

    @media (max-width: 1024px) {
        .container {
            grid-template-columns: 1fr;
        }
    }

    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip-text {
        visibility: hidden;
        background-color: #2d3748;
        color: white;
        text-align: center;
        padding: 8px 12px;
        border-radius: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.85em;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>

</head>
<body>
    <div class="container">
        <!-- Panel izquierdo: Generador PDF -->
        <div class="panel">
            <h2>üìÑ Generador de Plantilla PDF</h2>
            
            <div class="form-group">
                <label for="divs">N√∫mero de cl√∫sters</label>
                <input type="number" id="divs" value="4" min="2" max="20">
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="ddrsf">
                    <label for="ddrsf" style="margin: 0;">Mostrar booleanos (DDRSF)</label>
                </div>
            </div>

            <button onclick="generarPDF()">üöÄ Generar Plantilla PDF</button>

            <div class="divider"></div>

            <div style="background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                <strong style="color: #92400e;">üí° Instrucciones:</strong>
                <p style="color: #78350f; margin-top: 8px; font-size: 0.9em;">
                    Configure el n√∫mero de cl√∫sters y active los booleanos si desea visualizar 
                    las columnas D, D, R, S, F en la tabla FAT. Al generar, se descargar√° 
                    autom√°ticamente un PDF con la estructura del sistema de archivos FAT.
                </p>
            </div>
        </div>

        <!-- Panel derecho: Explorador FAT -->
        <div class="panel">
            <h2>üìã Explorador del Sistema FAT</h2>

            <div class="form-group">
                <label for="comandoSelect">Comando</label>
                <select id="comandoSelect" onchange="actualizarFormulario()">
                    <option value="mkdir">üìÅ Crear directorio</option>
                    <option value="addfile">üìÑ A√±adir archivo</option>
                    <option value="copy">üìã Copiar</option>
                    <option value="move">‚úÇÔ∏è Mover</option>
                    <option value="delete">üóëÔ∏è Eliminar</option>
                </select>
            </div>

            <div id="formExtra"></div>

            <button onclick="agregarInstruccion()">‚ûï A√±adir Instrucci√≥n</button>

            <div class="divider"></div>

            <h3>üìÅ √Årbol del Sistema de Archivos</h3>
            <pre id="vista">/ (ra√≠z)</pre>

            <h3>üìä Estad√≠sticas</h3>
            <div style="padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #bae6fd;">
                <span style="color: #0c4a6e; font-weight: 600;">Cl√∫sters utilizados: </span>
                <span class="stats-badge" id="maxClusters">0</span>
            </div>

            <h3>üìù Historial de Instrucciones</h3>
            <div id="listaInstrucciones">
                <div class="empty-state">
                    No hay instrucciones a√∫n. ¬°A√±ade la primera!
                </div>
            </div>
        </div>
    </div>

<script>
/* ============================================
   GENERADOR DE PDF
   ============================================ */
async function generarPDF() {
    const divs = parseInt(document.getElementById('divs').value);
    const mostrar_ddrsf = document.getElementById('ddrsf').checked;

    try {
        const url = 'assets/Plantilla_Sistemas_Operativos.pdf';
        const arrayBuffer = await fetch(url).then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const page = pdfDoc.getPages()[0];
        const { width, height } = page.getSize();

        const cuadros = [
            { x: 107, y: height - 133 - 322, w: 173, h: 322, tipo: "FAT" },
            { x: 540, y: height - 107 - 349, w: 213, h: 349, tipo: "DIRECTORIO" }
        ];

        const filas = Math.ceil(divs / 2);

        cuadros.forEach(cuadro => {
            const {x, y, w, h, tipo} = cuadro;
            
            // Rect√°ngulo principal
            page.drawRectangle({ 
                x, y, width: w, height: h, 
                borderColor: PDFLib.rgb(0, 0, 0), 
                borderWidth: 1 
            });
            
            // L√≠nea vertical central
            page.drawLine({ 
                start: {x: x + w/2, y}, 
                end: {x: x + w/2, y: y + h}, 
                color: PDFLib.rgb(0, 0, 0), 
                thickness: 1 
            });

            // L√≠neas horizontales
            const altura_fila = h / filas;
            for (let i = 1; i < filas; i++) {
                page.drawLine({ 
                    start: {x: x, y: y + i * altura_fila}, 
                    end: {x: x + w, y: y + i * altura_fila}, 
                    color: PDFLib.rgb(0, 0, 0), 
                    thickness: 1 
                });
            }

            // Numeraci√≥n de cl√∫sters
            let contador = 1;
            const columnas = [x, x + w/2];

            for (let fila = 0; fila < filas; fila++) {
                const y_fila = y + h - fila * altura_fila;
                columnas.forEach(col => {
                    page.drawText(`C${contador}`, { 
                        x: col + 2, 
                        y: y_fila - 10, 
                        size: 8 
                    });

                    // Booleanos DDRSF
                    if (tipo === "FAT" && mostrar_ddrsf) {
                        const izquierda = ["D", "D", "R"];
                        const derecha = ["S", "F"];
                        const esp = (altura_fila + 20) / (izquierda.length + 1);
                        
                        izquierda.forEach((l, idx) => 
                            page.drawText(l, {
                                x: col + 7, 
                                y: y_fila - (idx + 1) * esp, 
                                size: 12
                            })
                        );
                        
                        derecha.forEach((l, idx) => 
                            page.drawText(l, {
                                x: col + 45, 
                                y: y_fila - (idx + 1) * esp, 
                                size: 12
                            })
                        );
                    }
                    contador++;
                });
            }
        });

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Plantilla_FAT_" + new Date().getTime() + ".pdf";
        link.click();

        // Mensaje de √©xito
        mostrarNotificacion("‚úÖ PDF generado exitosamente", "success");

    } catch (err) {
        console.error("Error generando PDF:", err);
        mostrarNotificacion("‚ùå Error al generar el PDF. Verifica que el archivo de plantilla exista.", "error");
    }
}

/* ============================================
   EXPLORADOR DEL SISTEMA FAT
   ============================================ */
let root = {nombre: "/", tipo: "dir", hijos: [], clusters: 0};
let instrucciones = [];

function buscarNodo(ruta, nodo = root) {
    if (ruta === "/") return root;
    const partes = ruta.split("/").filter(Boolean);
    let actual = nodo;
    for (const p of partes) {
        actual = actual.hijos.find(h => h.nombre === p);
        if (!actual) return null;
    }
    return actual;
}

function generarDirectorios(nodo = root, path = "/") {
    let dirs = [path];
    nodo.hijos.filter(h => h.tipo === "dir").forEach(h => {
        const subPath = path === "/" ? `/${h.nombre}` : `${path}/${h.nombre}`;
        dirs = dirs.concat(generarDirectorios(h, subPath));
    });
    return dirs;
}

function generarElementos(nodo = root, path = "/") {
    let elems = [];
    if (path !== "/") elems.push({nombre: path, tipo: nodo.tipo});
    if (nodo.tipo === "dir") {
        nodo.hijos.forEach(h => {
            const subPath = path === "/" ? `/${h.nombre}` : `${path}/${h.nombre}`;
            elems = elems.concat(generarElementos(h, subPath));
        });
    }
    return elems;
}

function actualizarFormulario() {
    const cmd = document.getElementById('comandoSelect').value;
    const form = document.getElementById('formExtra');
    form.innerHTML = "";

    if (cmd === "mkdir") {
        form.innerHTML = `
            <div class="form-group">
                <label for="nombre">Nombre del directorio</label>
                <input type="text" id="nombre" placeholder="ej. juegos">
            </div>
            <div class="form-group">
                <label for="rutaSelect">Ubicaci√≥n destino</label>
                <select id="rutaSelect"></select>
            </div>
        `;
        llenarDirectorios("rutaSelect");
    }
    else if (cmd === "addfile") {
        form.innerHTML = `
            <div class="form-group">
                <label for="nombre">Nombre del archivo</label>
                <input type="text" id="nombre" placeholder="ej. documento.txt">
            </div>
            <div class="form-group">
                <label for="clusters">N√∫mero de cl√∫sters</label>
                <input type="number" id="clusters" value="1" min="1">
            </div>
            <div class="form-group">
                <label for="rutaSelect">Ubicaci√≥n destino</label>
                <select id="rutaSelect"></select>
            </div>
        `;
        llenarDirectorios("rutaSelect");
    }
    else if (cmd === "copy" || cmd === "move") {
        form.innerHTML = `
            <div class="form-group">
                <label for="elementoSelect">Elemento a ${cmd === "copy" ? "copiar" : "mover"}</label>
                <select id="elementoSelect"></select>
            </div>
            <div class="form-group">
                <label for="rutaSelect">Ubicaci√≥n destino</label>
                <select id="rutaSelect"></select>
            </div>
        `;
        llenarElementos("elementoSelect");
        llenarDirectorios("rutaSelect");
    }
    else if (cmd === "delete") {
        form.innerHTML = `
            <div class="form-group">
                <label for="elementoSelect">Elemento a eliminar</label>
                <select id="elementoSelect"></select>
            </div>
        `;
        llenarElementos("elementoSelect");
    }
}

function llenarDirectorios(id) {
    const select = document.getElementById(id);
    const dirs = generarDirectorios();
    select.innerHTML = "";
    dirs.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        select.appendChild(opt);
    });
}

function llenarElementos(id) {
    const select = document.getElementById(id);
    const elems = generarElementos();
    select.innerHTML = "";
    elems.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.nombre;
        opt.textContent = `${e.tipo === "dir" ? "üìÅ" : "üìÑ"} ${e.nombre}`;
        select.appendChild(opt);
    });
}

function agregarInstruccion() {
    const cmd = document.getElementById('comandoSelect').value;
    let instr = {cmd};

    try {
        if (cmd === "mkdir") {
            instr.nombre = document.getElementById('nombre').value.trim();
            if (!instr.nombre) throw new Error("El nombre no puede estar vac√≠o");
            instr.dest = document.getElementById('rutaSelect').value;
        }
        else if (cmd === "addfile") {
            instr.nombre = document.getElementById('nombre').value.trim();
            if (!instr.nombre) throw new Error("El nombre no puede estar vac√≠o");
            instr.clusters = parseInt(document.getElementById('clusters').value);
            if (instr.clusters < 1) throw new Error("El n√∫mero de cl√∫sters debe ser mayor a 0");
            instr.dest = document.getElementById('rutaSelect').value;
        }
        else if (cmd === "copy" || cmd === "move") {
            instr.elemento = document.getElementById('elementoSelect').value;
            instr.dest = document.getElementById('rutaSelect').value;
        }
        else if (cmd === "delete") {
            instr.elemento = document.getElementById('elementoSelect').value;
        }

        instrucciones.push(instr);
        actualizarLista();
        ejecutarInstr(instr);
        recalcularClusters();
        actualizarVista();
        
        mostrarNotificacion("‚úÖ Instrucci√≥n a√±adida correctamente", "success");
    } catch (error) {
        mostrarNotificacion("‚ùå " + error.message, "error");
    }
}

function actualizarLista() {
    const lista = document.getElementById('listaInstrucciones');
    
    if (instrucciones.length === 0) {
        lista.innerHTML = '<div class="empty-state">No hay instrucciones a√∫n. ¬°A√±ade la primera!</div>';
        return;
    }
    
    lista.innerHTML = "";
    instrucciones.forEach((i, idx) => {
        const div = document.createElement('div');
        div.className = "instr-item";
        
        const cmdText = {
            mkdir: "Crear dir",
            addfile: "A√±adir archivo",
            copy: "Copiar",
            move: "Mover",
            delete: "Eliminar"
        }[i.cmd] || i.cmd;
        
        let detalles = JSON.stringify(i);
        
        div.innerHTML = `
            <span class="instr-text">${idx + 1}. ${cmdText}: ${detalles}</span>
            <button class="btn-small" onclick="borrarInstr(${idx})">‚ùå</button>
        `;
        lista.appendChild(div);
    });
}

function borrarInstr(idx) {
    instrucciones.splice(idx, 1);
    actualizarLista();
    reconstruirDesdeCero();
    mostrarNotificacion("üóëÔ∏è Instrucci√≥n eliminada", "info");
}

function ejecutarInstr(i) {
    if (i.cmd === "mkdir") {
        const dest = buscarNodo(i.dest);
        if (dest) dest.hijos.push({nombre: i.nombre, tipo: "dir", hijos: [], clusters: 1});
    }
    else if (i.cmd === "addfile") {
        const dest = buscarNodo(i.dest);
        if (dest) dest.hijos.push({nombre: i.nombre, tipo: "file", clusters: i.clusters});
    }
    else if (i.cmd === "copy") {
        const elem = buscarNodo(i.elemento);
        const dest = buscarNodo(i.dest);
        if (elem && dest) {
            const copia = JSON.parse(JSON.stringify(elem));
            dest.hijos.push(copia);
        }
    }
    else if (i.cmd === "move") {
        const elem = buscarNodo(i.elemento);
        const partes = i.elemento.split("/").filter(Boolean);
        const nombre = partes.pop();
        const parent = buscarNodo("/" + partes.join("/"));
        const dest = buscarNodo(i.dest);
        if (elem && parent && dest) {
            parent.hijos = parent.hijos.filter(h => h.nombre !== nombre);
            dest.hijos.push(elem);
        }
    }
    else if (i.cmd === "delete") {
        const partes = i.elemento.split("/").filter(Boolean);
        const nombre = partes.pop();
        const parent = buscarNodo("/" + partes.join("/"));
        if (parent) parent.hijos = parent.hijos.filter(h => h.nombre !== nombre);
    }
}

function recalcularClusters() {
    const usar = contarClusters(root);
    document.getElementById("maxClusters").textContent = usar;
}

function contarClusters(nodo) {
    let total = 0;
    if (nodo !== root) total += (nodo.clusters || 0);
    if (nodo.tipo === "dir") nodo.hijos.forEach(h => total += contarClusters(h));
    return total;
}

function actualizarVista() {
    const pre = document.getElementById('vista');
    pre.textContent = imprimirArbol(root);
}

function imprimirArbol(nodo, pref = "") {
    let out = "";
    if (nodo !== root) {
        out += pref + (nodo.tipo === "dir" ? "üìÅ " : "üìÑ ") + nodo.nombre + " (" + (nodo.clusters || 0) + " cl√∫ster" + (nodo.clusters !== 1 ? "s" : "") + ")\n";
    }
    nodo.hijos?.forEach(h => {
        out += imprimirArbol(h, pref + "  ");
    });
    return out;
}

function reconstruirDesdeCero() {
    root = {nombre: "/", tipo: "dir", hijos: [], clusters: 0};
    instrucciones.forEach(i => ejecutarInstr(i));
    recalcularClusters();
    actualizarVista();
}

function mostrarNotificacion(mensaje, tipo) {
    // Simple alert por ahora - puedes mejorar esto con una librer√≠a de notificaciones
    console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
}

// Inicializaci√≥n
actualizarFormulario();
actualizarVista();
</script>
</body>
</html>

